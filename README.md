# relay-compiler-plus

[![npm version](https://img.shields.io/npm/v/relay-compiler-plus.svg?style=flat-square)](https://www.npmjs.com/package/relay-compiler-plus) [![npm downloads](https://img.shields.io/npm/dm/relay-compiler-plus.svg?style=flat-square)](https://www.npmjs.com/package/relay-compiler-plus) [![npm](https://img.shields.io/npm/dt/relay-compiler-plus.svg?style=flat-square)](https://www.npmjs.com/package/relay-compiler-plus) [![npm](https://img.shields.io/npm/l/relay-compiler-plus.svg?style=flat-square)](https://www.npmjs.com/package/relay-compiler-plus)

> **Custom relay compiler which supports persisted queries** :bowtie:

## Installation

npm i -g relay-compiler-plus

## Usage
At your project dir

```
relay-compiler-plus --schema <SCHEMA_FILE_PATH> --src <SRC_DIR_PATH>
```

where <SCHEMA_FILE_PATH> is the path to your schema.graphql or schema.json file.

After running this, you'll see the generated root query files (*.graphql.js) now contain ids and null text.

A queryMap.json file is also generated under <SRC_DIR_PATH>/queryMap.json.
This file can be consumed by the server to map the query ids to actual queries.

#### On the server
You can use the included matchQueryMiddleware on the server side alongside
express-graphql to match the queryIds.

First, add `relay-compiler-plus` to your project.
```
yarn add relay-compiler-plus
```

Next, use matchQueryMiddleware prior to express-graphql.
```
import Express from 'express';
import expressGraphl from 'express-graphql';
import {matchQueryMiddleware} from 'relay-compiler-plus';
import queryMapJson from '../queryMap.json'; // Should be auto-generated by

const app = Express();

app.use('/graphql',
  matchQueryMiddleware(queryMapJson),
  expressGraphl({
    schema: graphqlSchema,
    graphiql: true,
  }));
```

Lastly, on the client, modify your relay network fetch implementation to pass `queryId` instead of the actual query.
```
function fetchQuery(operation, variables,) {
  return fetch('/graphql', {
    method: 'POST',
    headers: {
      'content-type': 'application/json'
    },
    body: JSON.stringify({
      queryId: operation.id, // look ma, persisted queries!
      variables,
    }),
  }).then(response => {
    return response.json();
  });
}
```

## Example
Check the [example](https://github.com/yusinto/relay-compiler-plus/tree/master/example)
for a fully working demo.

